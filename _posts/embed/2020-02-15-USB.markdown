---
layout: post
title:  "USB"
categories: embed
---

**USB（Universal Serial Bus，通用串行总线）** 是一种广泛应用于计算机和嵌入式系统中的标准化通信接口，用于连接外部设备进行数据传输和供电。在嵌入式系统中，**USB** 可以实现高速数据传输，并且支持多种设备类型（如键盘、鼠标、存储设备等）的即插即用。STM32 微控制器内置 **USB 外设模块**，支持通过 USB 接口进行通信。

### **USB 的基本概念**

USB 是一种 **串行通信接口**，具备高传输速度、即插即用和支持热插拔等特点。USB 支持以下几种数据传输模式：
1. **控制传输**：用于设备配置和命令通信，确保设备能够正确连接并识别。
2. **中断传输**：用于对数据传输延迟要求较低但需要保证及时性的场合（如键盘、鼠标）。
3. **批量传输**：用于大数据量传输，例如 USB 存储设备。
4. **同步传输**：用于对实时数据有严格要求的场景，例如音频或视频设备。

#### **USB 的传输速度等级**：
- **USB 1.1**：支持 **1.5 Mbps（低速）** 和 **12 Mbps（全速）** 的传输速率。
- **USB 2.0**：支持 **480 Mbps（高速）**。
- **USB 3.0**：支持 **5 Gbps（超高速）**。
- **USB 3.1** 和 **USB 3.2**：进一步提升传输速率，达到 **10 Gbps** 和 **20 Gbps**。

在嵌入式系统中，常见的传输速度为 **USB 2.0 全速（12 Mbps）** 或 **USB 2.0 高速（480 Mbps）**，而 STM32 微控制器通常支持 **USB 2.0 全速** 通信。

### **STM32 微控制器中的 USB 外设**

STM32 微控制器集成了 **USB 外设**，可以通过 **USB 设备模式** 或 **USB 主机模式** 与外部设备通信。部分 STM32 微控制器还支持 **OTG（On-The-Go）模式**，可以在设备模式和主机模式之间动态切换。

#### **USB 模式**：
1. **USB 设备模式**：STM32 作为 USB 从设备与主机（如计算机）通信，典型应用包括 USB HID（如键盘、鼠标）、USB 存储、虚拟串口（CDC）等。
   
2. **USB 主机模式**：STM32 作为主机与外部 USB 设备通信，例如与 USB 存储设备通信、连接键盘、鼠标等。

3. **OTG（On-The-Go）模式**：OTG 是一种可以在设备模式和主机模式之间动态切换的技术，允许设备在不同情况下根据连接的对端设备自动选择合适的模式。例如，STM32 可以通过 OTG 接口既充当 USB 存储设备（设备模式），也可以作为主机与 U 盘进行通信。

#### **USB 引脚和硬件连接**
STM32 的 USB 外设通常使用以下几个关键引脚：
- **D+** 和 **D-**：这两个引脚用于 USB 的差分数据通信线，分别传输数据的正负电平信号。
- **VBUS**：为 USB 设备供电，通常为 **5V** 电源。
- **GND**：地线，用于电源和信号的参考电位。
- **ID**（可选）：在 OTG 模式下用于区分主机和设备模式。

在使用 USB 时，STM32 的特定引脚被配置为 **D+** 和 **D-**，通过 USB 线缆连接到外部 USB 主机或设备。

### **STM32 USB 应用场景**

STM32 微控制器支持多种 **USB 类（USB Class）**，这些类定义了不同设备的通信行为。常见的 USB 类包括：
1. **HID（Human Interface Device）**：
   - HID 类用于实现人机接口设备，如键盘、鼠标、游戏手柄等。STM32 作为 HID 设备可以通过 USB 与 PC 连接，实现键盘输入、鼠标控制等功能。
   
2. **CDC（Communication Device Class）**：
   - CDC 类支持虚拟串口通信（如 USB 转串口），STM32 可以通过 USB CDC 模拟串行端口，与计算机进行数据交换。这种模式常用于调试和串口通信。
   
3. **MSC（Mass Storage Class）**：
   - MSC 类允许 STM32 模拟为 USB 存储设备，如 U 盘，用户可以通过 USB 将数据存储在 STM32 上的存储器（如 Flash 或 SD 卡）中。

4. **Audio Class**：
   - 支持音频输入/输出设备，例如麦克风和扬声器。STM32 通过 USB Audio 类可以与计算机交换音频数据，用于音频传输和处理。

5. **OTG（On-The-Go）**：
   - STM32 通过 OTG 模式可以在 USB 设备和 USB 主机模式之间切换。例如，STM32 可以作为主机与 USB 存储设备进行通信，或作为设备与 PC 进行通信。

### **STM32 USB 示例：虚拟串口（USB CDC）**

以下是 STM32 作为 **USB 虚拟串口（CDC 类）** 的简单例子。STM32 可以通过 USB 连接到计算机，并模拟串口通信。

#### **1. 使用 STM32CubeMX 配置 USB**

1. 打开 **STM32CubeMX**，选择目标 STM32 芯片（如 **STM32F103C8T6**）。
2. 在外设配置中，启用 **USB_DEVICE**，选择 **CDC Class（虚拟串口）**。
3. 生成代码，并在 **STM32CubeIDE** 中打开项目。

#### **2. 初始化 USB CDC**

在 `usb_device.c` 文件中，初始化 USB CDC 设备：

```c
#include "usb_device.h"
#include "usbd_cdc_if.h"

// 主函数
int main(void) {
    HAL_Init();  // 初始化 HAL 库
    SystemClock_Config();  // 配置系统时钟
    MX_USB_DEVICE_Init();  // 初始化 USB 设备（虚拟串口）

    uint8_t message[] = "Hello, USB Virtual COM Port!\r\n";

    while (1) {
        // 通过 USB CDC 发送数据到 PC
        CDC_Transmit_FS(message, sizeof(message) - 1);
        HAL_Delay(1000);  // 每秒发送一次
    }
}
```

#### **3. 使用 CDC 发送和接收数据**

- **CDC_Transmit_FS()**：用于通过 USB 虚拟串口发送数据。
- 你可以通过 USB 线将 STM32 连接到计算机，并在 PC 端使用串口终端软件（如 PuTTY、Tera Term）查看从 STM32 发送的数据。

### **USB 的常见应用场景**

1. **USB HID（键盘、鼠标）**：
   - STM32 作为 USB HID 设备可以模拟键盘或鼠标，与计算机进行交互。例如，可以用 STM32 开发键盘设备，在按下按键时向计算机发送键盘扫描码。

2. **USB 存储设备**：
   - 通过 USB MSC 类，STM32 可以模拟为 USB 存储设备，用户可以通过计算机向 STM32 的存储空间读写数据。这在实现嵌入式文件系统（如 SD 卡、Flash）时非常有用。

3. **USB 音频设备**：
   - STM32 可以通过 USB Audio 类实现音频输入/输出功能，常用于音频传输应用，如麦克风、音频播放设备。

4. **USB OTG（主机模式）**：
   - 在 OTG 模式下，STM32 可以作为 USB 主机连接其他 USB 设备（如 USB 存储器、Wi-Fi 模块等），实现嵌入式设备的数据传输和扩展功能。

### **USB 的常见问题**

1. **USB 设备未识别**：
   - 如果 STM32 连接到 PC 后无法识别设备，可能是由于引脚配置错误、时钟未正确设置或 USB 电缆损坏。检查 USB 配置和电路连接，确保正确设置时钟源和供电。

2. **通信中断**：
   - USB 传输过程容易受电源波动或干扰影响，导致通信中断。确保使用屏蔽良好的 USB 线缆，并保持电源稳定。

3. **数据传输速率不稳定**：
   - 如果数据传输不稳定，可能是由于 USB 中断配置或 DMA 配置不当，调整 USB 配置并合理设置缓冲区大小以提高稳定性。

### **总结**

- **USB（通用串行总线）** 是一种广泛应用于嵌入式系统的高速数据传输接口。STM32

 微控制器内置 USB 外设，支持 USB 设备模式、主机模式和 OTG 模式。
- STM32 通过 USB 可以实现 HID 设备、虚拟串口、USB 存储、音频设备等功能，适合多种嵌入式应用。
- 通过 STM32CubeMX 和 HAL 库，开发者可以轻松配置和使用 STM32 的 USB 外设，处理 USB 通信任务。